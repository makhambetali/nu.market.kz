{% extends 'dist/main.html' %}
{% block content %}
{% load static %}
{% load custom_tag %}

<style>
	input[type="range"]::-webkit-slider-thumb {
		pointer-events: all;
		width: 24px;
		height: 24px;
		-webkit-appearance: none;
	}
</style>


<div class="container mx-auto px-6 py-0">
	<div class="flex flex-col md:flex-row md:space-x-6">
		<!-- Filters Section -->
		
		<aside class="mb-8 w-full border-r md:mb-0 md:w-1/6">
			<form method="get" action="{% url 'app:home-page' %}" class="filter-form">
				<div class="form-group">
					<label for="category">Категория:</label>
					<input type="hidden" name="previous_category" value="{{ category }}">
					<input type="hidden" name="previous_condition" value="{{ condition }}">
					<select name="category" id="category" class="form-control">
						<option value="" {% if not request.GET.category %}selected{% endif %}>Все категории</option>
						<!-- <option value="books" {% if request.GET.category == 'books' %}selected{% endif %}>Книги</option>
						<option value="electronics" {% if request.GET.category == 'electronics' %}selected{% endif %}>Электроника</option>
						<option value="furniture" {% if request.GET.category == 'furniture' %}selected{% endif %}>Мебель</option>
						<option value="clothing" {% if request.GET.category == 'clothing' %}selected{% endif %}>Одежда</option>
						<option value="others" {% if request.GET.category == 'others' %}selected{% endif %}>Прочие</option> -->
						
						{% for category in categories %}
						<!--  -->
						{% with request.GET.category|to_int as int_var %}
						<option value="{{category.id}}" {% if int_var == category.id %}selected{% endif %}>{{category.name}}</option>
						
						{% endwith %}
						{% endfor %}
					</select>
				</div>
			
				<div class="form-group">
					<label for="condition">Состояние:</label>
					<select name="condition" id="condition" class="form-control">
						<option value="" {% if not request.GET.condition %}selected{% endif %}>Все состояния</option>
						<option value="new" {% if request.GET.condition == 'new' %}selected{% endif %}>Новое</option>
						<option value="used" {% if request.GET.condition == 'used' %}selected{% endif %}>Б/у</option>
					</select>
				</div>
			
				{% if posts_count != 0 %}
				<div class="mt-4 flex items-center justify-center">
					<div
						x-data="range()"
						x-init="mintrigger(); maxtrigger()"
						class="relative w-full max-w-xl"
					>
<!-- 
				<p>Prev: {{previous_category}}</p>
				<p>Min Dot: {{min_dot}}</p>
				<p>Max Dot: {{max_dot}}</p>
				<p>Min Price of posts: {{min_price}}</p>
				<p>Max Price of posts: {{max_price}}</p> -->
						<div>
							<input
								type="range"
								step="100"
								x-bind:min="min"
								x-bind:max="max"
								x-on:input="mintrigger"
								x-model="minprice"
								class="pointer-events-none absolute z-20 h-2 w-full cursor-pointer appearance-none opacity-0"
							/>
		
							<input
								type="range"
								step="100"
								x-bind:min="min"
								x-bind:max="max"
								x-on:input="maxtrigger"
								x-model="maxprice"
								class="pointer-events-none absolute z-20 h-2 w-full cursor-pointer appearance-none opacity-0"
							/>
		
							<div class="relative z-10 h-2">
								<div
									class="absolute bottom-0 left-0 right-0 top-0 z-10 rounded-md bg-gray-200"
								></div>
		
								<div
									class="absolute bottom-0 top-0 z-20 rounded-md bg-blue-300"
									x-bind:style="'right:'+maxthumb+'%; left:'+minthumb+'%'"
								></div>
		
								<div
									class="absolute left-0 top-0 z-30 -ml-0.5 -mt-1 h-4 w-4 rounded-full bg-blue-300"
									x-bind:style="'left: '+minthumb+'%'"
								></div>
		
								<div
									class="absolute right-0 top-0 z-30 -mr-0.5 -mt-1 h-4 w-4 rounded-full bg-blue-300"
									x-bind:style="'right: '+maxthumb+'%'"
								></div>
							</div>
						</div>
		
						<div class=" items-center justify-between py-5">
							<div>
								<input
									type="text"
									name="min_price"
									maxlength="6"
									x-on:input="mintrigger"
									x-model="minprice"
									class="w-20 rounded border border-gray-200 px-2 text-center"
								/>
							</div>
							<div>
								<input
									type="text"
									name="max_price"
									maxlength="6"
									x-on:input="maxtrigger"
									x-model="maxprice"
									class="w-20 rounded border border-gray-200 px-2 text-center"
								/>
							</div>
						</div>
					</div>
		
					<script>
						function range() {
							return {
								minprice: "{{min_price}}",
								maxprice: "{{max_price}}",
								min: "{{min_dot}}",
								max: "{{max_dot}}",
								minthumb: 0,
								maxthumb: 0,
		
								mintrigger() {
									this.minprice = Math.min(
										this.minprice,
										this.maxprice - 500
									);
									this.minthumb =
										((this.minprice - this.min) /
											(this.max - this.min)) *
										100;
								},
		
								maxtrigger() {
									this.maxprice = Math.max(
										this.maxprice,
										this.minprice + 500
									);
									this.maxthumb =
										100 -
										((this.maxprice - this.min) /
											(this.max - this.min)) *
											100;
								},
							};
						}
					</script>
				</div>
				{% endif %}
			
				<button type="submit" class="btn btn-primary">Фильтровать</button>
			</form>
		</aside>
		
		<!-- Product Listings Section -->
		<div class="w-full md:w-3/4">
			<h2 class="my-4 text-xl font-semibold text-gray-800">
				Найдено {{posts_count}} объявлении
			</h2>
			<div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 container-ajax">
				<!-- Product Card -->
				 {% for post in posts %}
				 <div class="overflow-hidden rounded-md bg-white shadow-md cursor-pointer relative card" onclick="redirectTo('{{post.slug}}')">
					<img src="{{post.images.first.image.url}}" alt="Product Image" class="h-48 w-full object-cover" />
                            <div class="p-5 pt-3.5">
                                <div class="flex items-center justify-between gap-2">
                                    <p class="flex h-12 cursor-pointer items-center text-gray-800 hover:underline">{{post.title}}</p>
                                    
										{% check_for_like request.user.id post.id as is_liked_by_user %}
										{% if is_liked_by_user %}
										<label class="inline-flex cursor-pointer items-center heart-icon fill" post_id = "{{post.id}}">
											<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart-fill" viewBox="0 0 16 16">
												<path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
											</svg>
										</label>
										{% else %}
										<label class="inline-flex cursor-pointer items-center heart-icon" post_id = "{{post.id}}">

											<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16">
												<path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/>
											</svg>
										</label>
										{% endif %}
                                </div>
                                <p class="mb-4 mt-2 text-lg font-semibold text-gray-900 currency-text">{{post.price}}</p>
                                <div class="flex justify-between text-sm text-gray-600">
                                    <span><span class="created_at" date_input='{{post.created_at.date|date:"Y-m-d"}}' date_input_alternative = '{{post.created_at.date}}'></span> {{post.created_at.time}}</span>
                                    <span>Block {{post.block}}</span>
                                </div>
                            </div>
				 </div>
				 {% endfor %}
				{% if posts_count != 0 %} <div class="pagination">
					<div class="step-links">
						{% if page_obj.has_previous %}
							<a href="?{% if category %}category={{ category }}&{% endif %}{% if condition %}condition={{ condition }}&{% endif %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}page=1">&laquo; первая</a>
							<a href="?{% if category %}category={{ category }}&{% endif %}{% if condition %}condition={{ condition }}&{% endif %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}page={{ page_obj.previous_page_number }}">предыдущая</a>
						{% endif %}
				
						<p class="current">
							Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}.
						</p>
				
						{% if page_obj.has_next %}
							<a href="?{% if category %}category={{ category }}&{% endif %}{% if condition %}condition={{ condition }}&{% endif %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}page={{ page_obj.next_page_number }}">следующая</a>
							<a href="?{% if category %}category={{ category }}&{% endif %}{% if condition %}condition={{ condition }}&{% endif %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}page={{ page_obj.paginator.num_pages }}">последняя &raquo;</a>
						{% endif %}
					</div>
				</div>
				{% endif %}

			</div>
		</div>
	</div>
</div>



{% endblock %}
{% block externals %}
<script>
	
	const all_cards = document.querySelectorAll('.card')
	const heart_icons = document.querySelectorAll('.heart-icon')
	const priceElements = document.querySelectorAll('.currency-text');
	const created_at_dates = document.querySelectorAll('.created_at')
	const today = new Date('{{today|date:"Y-m-d"}}').setHours(0, 0, 0, 0);
    
    all_cards.forEach(function(element, index) {
        const price = parseFloat(priceElements[index].textContent.trim());
		
        if (!isNaN(price)) {
            priceElements[index].textContent = formatCurrency(price);
        }
		created_at_dates[index].textContent = formatDate(created_at_dates[index].getAttribute('date_input'), created_at_dates[index].getAttribute('date_input_alternative'))
		heart_icons[index].addEventListener('click', function(event){
			event.stopPropagation();
			event.preventDefault();
			if(heart_icons[index].classList.contains('fill')){
				heart_icons[index].innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16"> <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/></svg>'			
				heart_icons[index].classList.remove('fill');
				fetch(`/fav_posts/delete/${heart_icons[index].getAttribute('post_id')}`)
			}
			else{
				heart_icons[index].innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart-fill" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/></svg>'
				heart_icons[index].classList.add('fill');
				fetch(`/fav_posts/add/${heart_icons[index].getAttribute('post_id')}`)
			}
				}
			
	)
	});
	
	
    
	
</script>
{% endblock externals %}