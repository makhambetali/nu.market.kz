{% extends 'app/base.html' %}
{% block content %}
{% load static %}
{% load custom_tag %}
<style>
	hr {
		border-color: #e5e5e5;
	}
</style>

<div class="container mx-auto">
	<div class="grid grid-cols-8 py-4">
		<!-- Filters Section -->
		<div>
		</div>

		<!-- Product Listings Section -->
		<div class="col-span-6 grid grid-cols-4">

			<aside class="font-medium">
				<form method="get" action="{% url 'app:home-page-filter' %}"
					class="text-sm filter-form flex flex-col gap-y-3 me-4">

					<!-- Скрытое поле для поискового запроса -->
					<input hidden name="q" id="filter-search-query" value="{{ search_query|default_if_none:'' }}">
					
					<!-- Категории и подкатегории -->
					<span class="text-lg" lang-data="category">Categories</span>
					<ul class="text-[#0089D0] flex flex-col gap-y-3">
						{% get_categories as categories %}
						{% for category in categories %}
							<li>
								<div class="flex items-center gap-x-2">
									<button type="button" class="toggle-btn" data-target="subMenu{{ category.key }}" onclick="toggleMenu(event)">
										<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5 bg-white rounded-full border text-gray-500">
											<path fill-rule="evenodd" d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
										</svg>
									</button>
									<label >


                                        <input type="checkbox" {% if category.name in categories_chosen or not page_type or redirected%}checked {% endif %} class="category-checkbox" data-category="{{ category.id }}" value="{{category.name}}" data-target="subMenu{{ category.key }}" name="category" >
										<span lang-data="{{category.key}}">{{category.name}}</span>

									</label>
								</div>

							</li>
						{% endfor %}
					</ul>

					<!-- Условия -->
					<span class="text-lg" lang-data="condition">Condition</span>
					<div class="flex items-center gap-2">
						<label>
							<input type="checkbox" class="condition-checkbox" value="new" name="condition"
								{% if 'new' in conditions_chosen or not page_type or redirected%}checked{% endif %}>
							<span lang-data="new">New</span>
						</label>
					</div>
					<div class="flex items-center gap-2">
						<label>
							<input type="checkbox" class="condition-checkbox" value="used" name="condition"
								{% if 'used' in conditions_chosen or not page_type or redirected %}checked{% endif %}>
							<span lang-data="used">Used</span>
						</label>
					</div>
					<button type="submit">Filter</button>
				</form>
			</aside>





			<div class="col-span-3 flex flex-col">
				

				<span>Найдено: {{posts_count}}</span>
				<div class="grid  grid-cols-3 border-l">
					{% for post in posts %}

					<div
						class="bg-white card cursor-pointer flex flex-col px-3 py-4 gap-y-3 border-b border-r">
						<img src="{% if post.images.first.image.url %}{{post.images.first.image.url}}{% else %}https://www.buhuslugi.by/wp-content/themes/consultix/images/no-image-found-360x250.png {% endif %}" alt="Product Image" onclick="redirectTo('{{post.slug}}')"
							class="h-48 object-cover rounded" />
						<hr>
						<div class="flex flex-col gap-y-3">
								<span class="flex text-sm cursor-pointer hover:underline h-10">
									{{post.title}} - {{post.condition}}</span>
							<div class="flex justify-between text-xs text-gray-600">
								<span class="created_at" date_input='{{post.created_at.date|date:"Y-m-d"}}'
									date_input_alternative='{{post.created_at.date}}' time="{{post.created_at.time}}">
								</span>

							</div>
							<div class="flex text-lg font-semibold justify-between">
								<div class="flex">
									<p class="currency-text text tracking-tight">{{post.price}}</p>
									<span>&nbsp;₸</span>
								</div>
								{% check_for_like request.user.id post.id as is_liked_by_user %}
								{% if is_liked_by_user %}
								<label class="inline-flex cursor-pointer items-center heart-icon fill"
									post_slug="{{post.slug}}">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#EE2E2E"
										class="size-5">
										<path
											d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z" />
									</svg>

								</label>
								{% else %}
								<label class="inline-flex cursor-pointer items-center heart-icon" post_slug="{{post.slug}}">

									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
										stroke-width="1.5" stroke="currentColor" class="size-5">
										<path stroke-linecap="round" stroke-linejoin="round"
											d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
									</svg>

								</label>
								{% endif %}
								{% if post.creator == request.user %}
					<a href="{% url 'app:edit-post' post.slug  %}">Edit</a>
					<a href="{% url 'app:delete-post' post.slug  %}">Delete</a>
					{% endif %}
							</div>
						</div>
					</div>
					{% endfor %}

				</div>

				{% if posts_count != 0 %}<div class="pagination">
					<div class="step-links grid grid-cols-3 items-center">
						{% if page_obj.has_previous %}
						<div class="grid grid-cols-3">
							<a class="bg-[#FFBA24] text-center py-2 rounded block"
							   href="?q={{ search_query }}&{% for condition in conditions_chosen %}condition={{ condition }}&{% endfor %}{% for category in categories_chosen %}category={{ category }}&{% endfor %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}page=1">
								&laquo; First
							</a>
							<div></div>
							<a class="bg-[#FFBA24] text-center py-2 rounded block"
							   href="?q={{ search_query }}&{% for condition in conditions_chosen %}condition={{ condition }}&{% endfor %}{% for category in categories_chosen %}category={{ category }}&{% endfor %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}page={{ page_obj.previous_page_number }}">
								Previous
							</a>
						</div>
						{% else %}
						<div></div>
						{% endif %}

						<span class="current text-center">
							Page {{ page_obj.number }} out of {{ page_obj.paginator.num_pages }}
						</span>

						{% if page_obj.has_next %}
						<div class="grid grid-cols-3">
							<a class="bg-[#FFBA24] text-center py-2 rounded block"
							   href="?q={{ search_query }}&{% for condition in conditions_chosen %}condition={{ condition }}&{% endfor %}{% for category in categories_chosen %}category={{ category }}&{% endfor %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}page={{ page_obj.next_page_number }}">
								Next
							</a>
							<div></div>
							<a class="bg-[#FFBA24] text-center py-2 rounded block"
							   href="?q={{ search_query }}&{% for condition in conditions_chosen %}condition={{ condition }}&{% endfor %}{% for category in categories_chosen %}category={{ category }}&{% endfor %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}page={{ page_obj.paginator.num_pages }}">
								Last &raquo;
							</a>
						</div>
						{% endif %}
					</div>
				</div>

				{% endif %}

			</div>

		</div>
	</div>
</div>



{% endblock %}
{% block externals %}

<script>
	const all_cards = document.querySelectorAll('.card')
	const heart_icons = document.querySelectorAll('.heart-icon')
	const priceElements = document.querySelectorAll('.currency-text');
	const created_at_dates = document.querySelectorAll('.created_at')
	const today = new Date('{{today|date:"Y-m-d"}}').setHours(0, 0, 0, 0);

	function toggleMenu(event) {
		// Close other open submenus
		document.querySelectorAll('.flex .flex-col .hidden').forEach(subMenu => {
			if (subMenu !== document.getElementById(event.target.closest('button').dataset.target)) {
				subMenu.classList.add("hidden");
			}
		});

		// Toggle current submenu
		var targetId = event.target.closest('button').dataset.target;
		var subMenu = document.getElementById(targetId);
		subMenu.classList.toggle("hidden");
	}

	all_cards.forEach(function (element, index) {
		const price = parseFloat(priceElements[index].textContent.trim());

		if (!isNaN(price)) {
			priceElements[index].textContent = formatCurrency(price);
		}
		created_at_dates[index].textContent = formatDate(created_at_dates[index].getAttribute('date_input'), created_at_dates[index].getAttribute('date_input_alternative'), created_at_dates[index].getAttribute('time'))
		heart_icons[index].addEventListener('click', function (event) {
			// alert()
			event.preventDefault();
			event.stopPropagation();
			if (heart_icons[index].classList.contains('fill')) {
				heart_icons[index].innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5"> <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" /> </svg>'
				heart_icons[index].classList.remove('fill');
				fetch(`/fav_posts/delete/${heart_icons[index].getAttribute('post_slug')}`)
			}
			else {
				heart_icons[index].innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#EE2E2E" class="size-5"> <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z" /> </svg>'
				heart_icons[index].classList.add('fill');
				fetch(`/fav_posts/add/${heart_icons[index].getAttribute('post_slug')}`)
			}
		}

		)
	})




</script>
<script>
	document.addEventListener('DOMContentLoaded', function() {
		const searchInput = document.getElementById('default-search');
    const filterSearchQueryInput = document.getElementById('filter-search-query');

    // При изменении значения в поисковой форме, копируем это значение в скрытое поле формы фильтрации
    searchInput.addEventListener('input', function() {
        filterSearchQueryInput.value = searchInput.value;
    });

    // Логика добавления фильтров в форму поиска остаётся прежней
    const searchForm = document.getElementById('search-form');
    const filterForm = document.querySelector('.filter-form');

    function addFiltersToSearchForm() {
        // Удаляем старые скрытые поля
        const oldInputs = searchForm.querySelectorAll('input[type="hidden"]');
        oldInputs.forEach(input => input.remove());

        // Копируем выбранные фильтры в форму поиска
        const filterInputs = filterForm.querySelectorAll('input:checked');
        filterInputs.forEach(input => {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = input.name;
            hiddenInput.value = input.value;
            searchForm.appendChild(hiddenInput);
        });
    }

    // При отправке формы поиска добавляем фильтры
    searchForm.addEventListener('submit', addFiltersToSearchForm);

   });

</script>
{% endblock externals %}