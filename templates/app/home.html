{% extends 'app/base.html' %}
{% block content %}
{% load static %}
{% load custom_tag %}
<style>
	hr {
		border-color: #e5e5e5;
	}
</style>

<div class="container mx-auto lg:px-16 px-4">
	<div class="grid lg:grid-cols-12 lg:gap-x-5 gap-x-4 py-4 grid-cols-6">
		<!-- Filters Section -->
		<aside class="col-span-3">
			<form method="get" action="{% url 'app:home-page' %}"
				class="filter-form lg:flex flex-col gap-y-5 px-6 py-4 border rounded-2xl hidden">
				
				<input type="hidden" name="previous_category" value="{{ category }}">
				
					<span class="text-xl font-bold">Categories</span>
					<hr>
					<ul class="text-[#666666] flex flex-col gap-y-4">
					{% for category in categories %}
						<li>
							<div class="flex items-center justify-between">
								<button name="category" id="category" value="{{category.id}}"
									class="hover:underline !leading-5">{{category.name}}</button>
								<button type="button" class="toggle-btn" data-target="subMenu{{category.key}}" onclick="toggleMenu(event)">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5">
										<path fill-rule="evenodd"
											d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z"
											clip-rule="evenodd" />
									</svg>
							
								</button>
							</div>
							<ul class="hidden pl-4" id="subMenu{{category.key}}">
								{% for subcategory in category.subcategories.all %}
								<li>{{ subcategory.name }}</li>
							{% endfor %}
							</ul>
						</li>
						{% endfor %}
				
					</ul>
				<!-- </div> -->

				<hr class="border-gray-300">
			

				<span class="text-xl font-bold">Price</span>
				{% if posts_count == 0 or posts_count == 1 %}
				{% else %}
				{% endif %}

				<hr>
				<span class="text-xl font-bold">Condition</span>
				<div class="flex flex-col gap-y-2">
					<div class="flex items-center gap-2">
						<input name="condition" id="condition" type="radio" value="new"
						{% if not request.GET.condition %}{% elif request.GET.condition == 'new' %}checked{% endif %}
							class="w-4 h-4 !text-[#FFBA24] bg-gray-100 border-gray-300 !ring-transparent">
						<span>New</span>
					</div>
					<div class="flex items-center gap-2">
						<input name="condition" id="condition" type="radio" value="used" 
						{% if not request.GET.condition %}{% elif request.GET.condition == 'used' %}checked{% endif %}
							class="w-4 h-4 !text-[#FFBA24] bg-gray-100 border-gray-300 !ring-transparent">
						<span>Used</span>
					</div>
				</div>
			</form>
		</aside>
		<!-- Product Listings Section -->
		<div class="lg:col-span-9 col-span-6">
			<!-- <div class="pb-4 flex justify-between">
				<span>Home</span>
				<div class="flex gap-x-3 text-[#666666]">
					<span>Showing 1-10 of 100 Products</span>
					<div class="flex"><span>Sort by:&nbsp;</span><button class="text-black">Most Popular</button></div>
				</div>
			</div> -->
				<div class="flex flex-col">
					<!-- Product Card -->
					<div class="grid lg:grid-cols-3 grid-cols-2 lg:gap-x-5 gap-x-4 lg:gap-y-9 gap-y-6">
						{% for post in posts %}
						
						<div 
							class="bg-white card cursor-pointer flex flex-col">
							<img src="{{post.images.first.image.url}}" alt="Product Image" onclick="redirectTo('{{post.slug}}')"
								class="aspect-[1/1] object-cover rounded-2xl mb-4"/>
									<span class="hover:underline text-lg mb-2">
										{{post.title}}</span>
	
								<div class="flex text-2xl font-bold justify-between  mb-2">
									<div class="flex">
										<span>â‚¸</span>
										<p class="currency-text">{{post.price}}</p> 
									</div>
									
									{% if post.creator == request.user %}
									
									<a href="{% url 'app:edit-post' post.slug  %}">Edit</a> 
									{% else %}
									{% check_for_like request.user.id post.id as is_liked_by_user %}
									{% if is_liked_by_user %}
									<label class="inline-flex cursor-pointer items-center heart-icon fill"
										post_id="{{post.id}}">
										<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#EE2E2E"
											class="size-5">
											<path
												d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z" />
										</svg>
	
									</label>
									{% else %}
									<label class="inline-flex cursor-pointer items-center heart-icon" post_id="{{post.id}}">
	
										<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
											stroke-width="1.5" stroke="currentColor" class="size-5">
											<path stroke-linecap="round" stroke-linejoin="round"
												d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
										</svg>
	
									</label>
									{% endif %}
									{% endif %}
								</div>
	
								<div class="flex justify-between text-xs text-gray-600">
									<span class="created_at" date_input='{{post.created_at.date|date:"Y-m-d"}}'
										date_input_alternative='{{post.created_at.date}}' time="{{post.created_at.time}}">
									</span>
									<span>Block {{post.block}}</span>
								</div>
						</div>
						{% endfor %}
	
					</div>
	
					{% if posts_count != 0 %} <div class="pagination">
						<div class="step-links grid grid-cols-3 items-center">
							{% if page_obj.has_previous %}
							<div class="grid grid-cols-3">
								<a class="bg-[#FFBA24] text-center py-2 rounded block"
									href="?{% if category %}category={{ category }}&{% endif %}{% if condition %}condition={{ condition }}&{% endif %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}page=1">&laquo;
									First</a>
								<div></div>
								<a class="bg-[#FFBA24] text-center py-2 rounded block"
									href="?{% if category %}category={{ category }}&{% endif %}{% if condition %}condition={{ condition }}&{% endif %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a>
	
							</div>
							{% else %}
							<div></div>
							{% endif %}
	
							<span class="current text-center">
								Page {{ page_obj.number }} out of {{ page_obj.paginator.num_pages }}
							</span>
	
							{% if page_obj.has_next %}
							<div class="grid grid-cols-3">
								<a class="bg-[#FFBA24] text-center py-2 rounded block"
									href="?{% if category %}category={{ category }}&{% endif %}{% if condition %}condition={{ condition }}&{% endif %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}page={{ page_obj.next_page_number }}">
									Next</a>
								<div></div>
								<a class="bg-[#FFBA24] text-center py-2 rounded block"
									href="?{% if category %}category={{ category }}&{% endif %}{% if condition %}condition={{ condition }}&{% endif %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}page={{ page_obj.paginator.num_pages }}">Last
									&raquo;</a>
							</div>
							{% endif %}
						</div>
					</div>
					{% endif %}
	
				</div>

		</div>
	</div>
</div>



{% endblock %}
{% block externals %}
<script>
	const all_cards = document.querySelectorAll('.card')
	const heart_icons = document.querySelectorAll('.heart-icon')
	const priceElements = document.querySelectorAll('.currency-text');
	const created_at_dates = document.querySelectorAll('.created_at')
	const today = new Date('{{today|date:"Y-m-d"}}').setHours(0, 0, 0, 0);

	function toggleMenu(event) {
		// Close other open submenus
		document.querySelectorAll('.flex .flex-col .hidden').forEach(subMenu => {
			if (subMenu !== document.getElementById(event.target.closest('button').dataset.target)) {
				subMenu.classList.add("hidden");
			}
		});

		// Toggle current submenu
		var targetId = event.target.closest('button').dataset.target;
		var subMenu = document.getElementById(targetId);
		subMenu.classList.toggle("hidden");
	}

	all_cards.forEach(function (element, index) {
		const price = parseFloat(priceElements[index].textContent.trim());

		if (!isNaN(price)) {
			priceElements[index].textContent = formatCurrency(price);
		}
		created_at_dates[index].textContent = formatDate(created_at_dates[index].getAttribute('date_input'), created_at_dates[index].getAttribute('date_input_alternative'), created_at_dates[index].getAttribute('time'))
		heart_icons[index].addEventListener('click', function (event) {
			// alert()
			event.preventDefault();
			event.stopPropagation();
			if (heart_icons[index].classList.contains('fill')) {
				heart_icons[index].innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5"> <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" /> </svg>'
				heart_icons[index].classList.remove('fill');
				fetch(`/fav_posts/delete/${heart_icons[index].getAttribute('post_id')}`)
			}
			else {
				heart_icons[index].innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#EE2E2E" class="size-5"> <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z" /> </svg>'
				heart_icons[index].classList.add('fill');
				fetch(`/fav_posts/add/${heart_icons[index].getAttribute('post_id')}`)
			}
		}

		)
	})




</script>
{% endblock externals %}